name: Deploy MkDocs via GitHub Pages

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - mkdocs.yml
  - docs/**
      - RESEARCH/**
      - RESEARCH
      - modules/**/docs/**
      - .gitmodules
      - scripts/generate_research_rss.py
      - .github/workflows/deploy-pages-mkdocs.yml

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: '1'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Init selected submodules (RESEARCH + modules/* via HTTPS)
        run: |
          if [ -f .gitmodules ]; then
            # Convert all submodule URLs to HTTPS to avoid SSH key requirements
            git config -f .gitmodules --get-regexp '^submodule\..*\.url$' | while read -r key url; do
              if echo "$url" | grep -q '^git@github.com:'; then
                https_url=$(echo "$url" | sed -E 's#^git@github.com:(.*)#https://github.com/\1#')
                git config -f .gitmodules "$key" "$https_url"
              fi
            done
            git submodule sync --recursive
            # Initialize only submodules that are required for docs aggregation
            # Always init RESEARCH; then init modules/* if present
            if git config -f .gitmodules --name-only --get-regexp '^submodule\.RESEARCH\.' >/dev/null 2>&1; then
              git submodule update --init RESEARCH || true
            fi
            # Init modules/* if any
            git config -f .gitmodules --get-regexp '^submodule\.modules/' | awk '{print $1}' | sed -E 's/^submodule\.([^.]*)\..*/\1/' | while read -r name; do
              path=$(git config -f .gitmodules --get "submodule.${name}.path" || true)
              if [ -n "$path" ]; then
                git submodule update --init "$path" || true
              fi
            done
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install MkDocs deps
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: '1'
        run: |
          python -m pip install --upgrade pip
          if [ -f docs/requirements.txt ]; then pip install -r docs/requirements.txt; else pip install mkdocs mkdocs-material; fi

      - name: Aggregate submodule docs into docs/modules/_ext
        run: |
          python scripts/aggregate_submodule_docs.py

      - name: Generate modules index
        run: |
          python scripts/generate_modules_docs_index.py

      - name: Generate RESEARCH RSS feed
        env:
          SITE_URL: https://paninifs.org
        run: |
          python scripts/generate_research_rss.py

      - name: Build MkDocs
        run: |
          mkdocs build --clean --strict

      - name: Add CNAME to artifact
        run: |
          echo "paninifs.org" > ./site/CNAME

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
