name: Pages Diagnostics

on:
  workflow_dispatch:

jobs:
  diag:
    name: Inspect Pages & gh-pages
    runs-on: ubuntu-latest
    concurrency:
      group: pages-diagnostics
      cancel-in-progress: false
    env:
      GIT_PAGER: cat
      GH_PAGER: cat
      PAGER: cat
      LESS: FRSX
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: gh-pages
          submodules: false

      - name: List top files in gh-pages
        run: |
          ls -la | sed -n '1,200p'
          echo "---- CNAME ----"; (head -n 5 CNAME || true)
          echo "---- index.html (head) ----"; (sed -n '1,50p' index.html || true)

      - name: Repo default branch & Pages settings
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const { data: repository } = await github.rest.repos.get(repo);
            const { data: pages } = await github.rest.repos.getPages(repo).catch(e => ({ data: { error: e.message } }));
            core.info(`default_branch=${repository.default_branch}`);
            core.info(`pages.cname=${pages?.cname}`);
            core.info(`pages.https_enforced=${pages?.https_enforced}`);
            core.info(`pages.status=${pages?.status}`);
            core.info(`pages.build_type=${pages?.build_type}`);
            if (pages?.error) core.warning(`pages.error=${pages.error}`);

      - name: Curl site (HTTPS)
        run: |
          set -x
          curl -fsSIL --max-time 20 https://paninifs.org || true
          echo "\n---- Fetch body (first 80 lines) ----"
          curl -fsSL --max-time 20 https://paninifs.org | sed -n '1,80p' || true
